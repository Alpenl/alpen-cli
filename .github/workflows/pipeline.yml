name: CI/CD Pipeline

# è§¦å‘æ¡ä»¶:
# 1. Push åˆ° main/dev åˆ†æ”¯ - è¿è¡Œå®Œæ•´è´¨é‡æ£€æŸ¥,dev åˆ†æ”¯é¢å¤–æ„å»ºæµ‹è¯•åŒ…
# 2. Pull Request åˆ° main/dev - è¿è¡Œå®Œæ•´è´¨é‡æ£€æŸ¥
# 3. æ¨é€ç‰ˆæœ¬æ ‡ç­¾ (v*) - è¿è¡Œæ£€æŸ¥ + æ„å»ºæ­£å¼å‘å¸ƒåŒ…
# 4. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch) - è¿è¡Œå®Œæ•´æµç¨‹
on:
  push:
    branches: [main, dev]
    tags: ["v*"]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: ä»£ç è´¨é‡æ£€æŸ¥ (æ€»æ˜¯è¿è¡Œ)
  # ============================================
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.1'  # ä¸ go.mod ä¿æŒä¸€è‡´
          cache: true

      - name: ğŸ“ æ£€æŸ¥ä»£ç æ ¼å¼
        run: |
          files=$(gofmt -l .)
          if [ -n "$files" ]; then
            echo "âŒ è¯·è¿è¡Œ gofmt ä¿®å¤ä»¥ä¸‹æ–‡ä»¶:"
            echo "$files"
            exit 1
          fi
          echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

      - name: ğŸ” é™æ€ä»£ç æ£€æŸ¥
        uses: golangci/golangci-lint-action@v3
        with:
          version: v1.61  # æ”¯æŒ Go 1.23
          args: --timeout=5m

      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: go test -v ./...

  # ============================================
  # Job 2: æ„å»º Debian è½¯ä»¶åŒ…
  # æ¡ä»¶: dev åˆ†æ”¯ push æˆ–ç‰ˆæœ¬æ ‡ç­¾ push æˆ–æ‰‹åŠ¨è§¦å‘
  # ============================================
  build-deb:
    name: æ„å»º Debian è½¯ä»¶åŒ…
    needs: quality-check  # ä¾èµ–è´¨é‡æ£€æŸ¥é€šè¿‡
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.ref == 'refs/heads/dev' ||
      startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-22.04

    env:
      GOFLAGS: "-mod=mod"
      # Debian åŒ…æ„å»ºç¯å¢ƒå˜é‡
      DEBEMAIL: "ci@alpen.dev"
      DEBFULLNAME: "Alpen CI Bot"

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²,ä¾¿äºç‰ˆæœ¬å·å¤„ç†

      - name: ğŸ”§ è®¾ç½® Go å¼€å‘ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.1'
          cache: true

      - name: ğŸ“¦ å®‰è£… Debian æ‰“åŒ…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            debhelper \
            devscripts \
            lintian \
            fakeroot

      - name: â¬‡ï¸  ä¸‹è½½ Go æ¨¡å—ä¾èµ–
        run: go mod download

      - name: ğŸ—ï¸  æ„å»º Debian è½¯ä»¶åŒ…
        run: |
          echo "å¼€å§‹æ„å»º Debian åŒ…..."
          dpkg-buildpackage -us -uc -b
          echo "æ„å»ºå®Œæˆ!"
          echo "ç§»åŠ¨æ„å»ºäº§ç‰©åˆ°å·¥ä½œç›®å½•..."
          mv ../*.deb ../*.changes ../*.buildinfo . 2>/dev/null || true
          ls -lh *.deb

      - name: âœ… Debian åŒ…è´¨é‡æ£€æŸ¥
        continue-on-error: true
        run: |
          echo "æ‰§è¡Œ lintian è´¨é‡æ£€æŸ¥..."
          lintian --info *.changes || true

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages-${{ github.sha }}
          path: |
            *.deb
            *.changes
            *.buildinfo
          retention-days: 30

      # ä»…åœ¨æ ‡ç­¾æ¨é€æ—¶åˆ›å»º GitHub Release
      - name: ğŸš€ åˆ›å»º GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: "*.deb"
          body: |
            ## Alpen CLI ${{ github.ref_name }}

            ### å®‰è£…æ–¹æ³•
            ```bash
            # ä¸‹è½½ .deb æ–‡ä»¶åæ‰§è¡Œ:
            sudo dpkg -i alpen-cli_*.deb

            # å¦‚æœ‰ä¾èµ–é—®é¢˜,è¿è¡Œ:
            sudo apt-get install -f
            ```

            ### éªŒè¯å®‰è£…
            ```bash
            alpen --version
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
