name: Windows Build Pipeline

# è§¦å‘æ¡ä»¶:
# 1. Push åˆ° windows-support åˆ†æ”¯
# 2. æ¨é€ Windows ç‰ˆæœ¬æ ‡ç­¾ (vw*)
# 3. æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [windows-support]
    tags: ["vw*"]  # Windows ä¸“ç”¨æ ‡ç­¾ï¼Œå¦‚ vw0.3.0
  pull_request:
    branches: [windows-support]
  workflow_dispatch:

# GitHub Actions æƒé™é…ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»º Release
  packages: write  # å…è®¸ä¸Šä¼ æ„å»ºäº§ç‰©

jobs:
  # ============================================
  # Job 1: ä»£ç è´¨é‡æ£€æŸ¥ (æ€»æ˜¯è¿è¡Œ)
  # ============================================
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.1'
          cache: true

      - name: ğŸ“ æ£€æŸ¥ä»£ç æ ¼å¼
        run: |
          files=$(gofmt -l .)
          if [ -n "$files" ]; then
            echo "âŒ è¯·è¿è¡Œ gofmt ä¿®å¤ä»¥ä¸‹æ–‡ä»¶:"
            echo "$files"
            exit 1
          fi
          echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

      - name: ğŸ” é™æ€ä»£ç æ£€æŸ¥
        uses: golangci/golangci-lint-action@v3
        with:
          version: v1.61
          args: --timeout=5m

      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: go test -v ./...

  # ============================================
  # Job 2: æ„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶
  # ============================================
  build-windows:
    name: æ„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶
    needs: quality-check
    runs-on: windows-latest
    timeout-minutes: 15

    env:
      GOFLAGS: "-mod=mod"
      GOPROXY: "https://proxy.golang.org,direct"

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ è®¾ç½® Go å¼€å‘ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.1'
          cache: true
          cache-dependency-path: go.sum

      - name: â¬‡ï¸  ä¸‹è½½ Go æ¨¡å—ä¾èµ–
        timeout-minutes: 5
        run: |
          Write-Host "å¼€å§‹ä¸‹è½½ Go æ¨¡å—..."
          go mod download
          Write-Host "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

      - name: ğŸ—ï¸  æ„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶
        timeout-minutes: 5
        shell: pwsh
        run: |
          Write-Host "å¼€å§‹æ„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶..."

          # æå–ç‰ˆæœ¬å·
          $VERSION = if ($env:GITHUB_REF -match 'refs/tags/vw(.+)') {
            $matches[1]
          } elseif ($env:GITHUB_REF -match 'refs/tags/v(.+)') {
            $matches[1]
          } else {
            "0.0.0-dev+$($env:GITHUB_SHA.Substring(0,7))"
          }
          Write-Host "ç‰ˆæœ¬å·: $VERSION"

          # è·å–æ„å»ºä¿¡æ¯
          $COMMIT = git rev-parse --short HEAD
          $BUILD_DATE = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          # æ„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶
          go build -v `
            -trimpath `
            -ldflags="-s -w `
              -X 'github.com/alpen/alpen-cli/cmd.version=$VERSION' `
              -X 'github.com/alpen/alpen-cli/cmd.commit=$COMMIT' `
              -X 'github.com/alpen/alpen-cli/cmd.date=$BUILD_DATE'" `
            -o alpen.exe `
            .

          Write-Host "âœ… Windows å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå®Œæˆ"

          # éªŒè¯æ–‡ä»¶
          if (Test-Path alpen.exe) {
            $fileInfo = Get-Item alpen.exe
            Write-Host "ğŸ“‹ æ–‡ä»¶ä¿¡æ¯:"
            Write-Host "  å¤§å°: $([math]::Round($fileInfo.Length/1MB, 2)) MB"
            Write-Host "  è·¯å¾„: $($fileInfo.FullName)"

            # å°è¯•è·å–ç‰ˆæœ¬ä¿¡æ¯
            try {
              & .\alpen.exe --version
            } catch {
              Write-Host "ç‰ˆæœ¬æ£€æŸ¥è·³è¿‡"
            }
          } else {
            Write-Error "âŒ æ„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ° alpen.exe"
            exit 1
          }

          # ä¿å­˜ç‰ˆæœ¬å·ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION=$VERSION" >> $env:GITHUB_ENV

      - name: ğŸ“¦ åˆ›å»ºå‘å¸ƒå‹ç¼©åŒ…
        shell: pwsh
        run: |
          Write-Host "åˆ›å»ºå‘å¸ƒåŒ…..."

          $VERSION = $env:VERSION
          $PACKAGE_NAME = "alpen-cli-$VERSION-windows-amd64"

          # åˆ›å»ºå‘å¸ƒç›®å½•
          New-Item -ItemType Directory -Path $PACKAGE_NAME -Force | Out-Null

          # å¤åˆ¶æ–‡ä»¶
          Copy-Item alpen.exe "$PACKAGE_NAME\"
          Copy-Item README.md "$PACKAGE_NAME\" -ErrorAction SilentlyContinue
          Copy-Item WINDOWS_SUPPORT.md "$PACKAGE_NAME\" -ErrorAction SilentlyContinue

          # åˆ›å»ºå®‰è£…è¯´æ˜æ–‡ä»¶
          $installText = "# Alpen CLI for Windows - Installation Guide`n`n"
          $installText += "## Quick Install`n`n"
          $installText += "1. Copy alpen.exe to any directory (Recommended: C:/Program Files/alpen/)`n"
          $installText += "2. Add to PATH environment variable`n"
          $installText += "3. Verify: alpen --version`n`n"
          $installText += "## Usage Examples`n`n"
          $installText += "alpen ls       # List commands`n"
          $installText += "alpen cc any   # Switch environment`n"
          $installText += "alpen --help   # Show help`n`n"
          $installText += "## Documentation`n`n"
          $installText += "GitHub: https://github.com/Alpenl/alpen-cli`n"
          $installText += "Version: $env:VERSION`n"
          $installText | Out-File -FilePath "$PACKAGE_NAME\INSTALL.txt" -Encoding UTF8

          # åˆ›å»º ZIP å‹ç¼©åŒ…
          Compress-Archive -Path $PACKAGE_NAME -DestinationPath "$PACKAGE_NAME.zip" -Force

          Write-Host "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
          Get-Item "$PACKAGE_NAME.zip" | Format-List Name, Length

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable-${{ github.sha }}
          path: |
            alpen.exe
            alpen-cli-*-windows-amd64.zip
          retention-days: 30

      # ä»…åœ¨æ ‡ç­¾æ¨é€æ—¶åˆ›å»º GitHub Release
      - name: ğŸš€ åˆ›å»º GitHub Release (Windows)
        if: startsWith(github.ref, 'refs/tags/vw')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            alpen.exe
            alpen-cli-*-windows-amd64.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ğŸ“¦ Windows ç‰ˆæœ¬å®‰è£…æ–¹æ³•

            ### å¿«é€Ÿå®‰è£…

            1. **ä¸‹è½½ exe æ–‡ä»¶**
               - ç›´æ¥ä¸‹è½½ï¼š[alpen.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/alpen.exe)
               - æˆ–ä¸‹è½½ ZIP åŒ…å¹¶è§£å‹

            2. **é…ç½®ç¯å¢ƒå˜é‡**
               ```
               å°† alpen.exe æ‰€åœ¨ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿ PATH
               ```

            3. **éªŒè¯å®‰è£…**
               ```cmd
               alpen --version
               ```

            ### åŠŸèƒ½ç‰¹æ€§

            - âœ… åŸç”Ÿ Windows æ”¯æŒ (cmd.exe)
            - âœ… ç¯å¢ƒå˜é‡è‡ªåŠ¨è½¬æ¢ (export â†’ set)
            - âœ… å‰ªè´´æ¿åŠŸèƒ½ (Ctrl+V)
            - âœ… é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†

            ### ä½¿ç”¨ç¤ºä¾‹

            ```cmd
            REM æŸ¥çœ‹å‘½ä»¤åˆ—è¡¨
            alpen ls

            REM åˆ‡æ¢ç¯å¢ƒå˜é‡
            alpen cc any
            REM ç„¶åæŒ‰ Ctrl+V ç²˜è´´æ‰§è¡Œ

            REM æŸ¥çœ‹å¸®åŠ©
            alpen --help
            ```

            ### è¯¦ç»†æ–‡æ¡£

            - [Windows æ”¯æŒæ–‡æ¡£](https://github.com/${{ github.repository }}/blob/windows-support/WINDOWS_SUPPORT.md)
            - [å®Œæ•´ README](https://github.com/${{ github.repository }}/blob/windows-support/README.md)

            ---
            **ç‰ˆæœ¬**: ${{ github.ref_name }}
            **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
